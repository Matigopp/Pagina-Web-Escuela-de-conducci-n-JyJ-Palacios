<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Usuarios - Escuela de Conductores J&J Palacios SPA</title>
    <style>
        :root {
            --brand-red: #f53333;
            --brand-black: #1a1a1a;
            --brand-white: #ffffff;
            --brand-gray: #f4f4f4;
            --brand-gray-strong: #e3e3e3;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            color: var(--brand-black);
            background-color: var(--brand-white);
        }

        header {
            background-color: var(--brand-red);
            padding: 0.8rem 1.8rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .logo-link {
            display: inline-flex;
            align-items: center;
            text-decoration: none;
            color: white;
        }

        .logo-container {
            display: flex;
            align-items: center;
            font-weight: bold;
            font-size: 1.1rem;
            gap: 10px;
        }

        .logo-img {
            width: 48px;
            height: auto;
            border-radius: 50%;
            border: 2px solid white;
            object-fit: cover;
        }

        nav a {
            color: white;
            text-decoration: none;
            margin: 0 12px;
            font-weight: 600;
            transition: opacity 0.3s ease;
        }

        nav a:hover {
            opacity: 0.85;
        }

        .enlace-admin {
            display: none;
        }

        .enlace-admin.visible {
            display: inline;
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 50px 20px 80px;
        }

        .titulo-seccion {
            text-align: center;
            color: var(--brand-red);
            font-size: 2.1rem;
            text-transform: uppercase;
            margin-bottom: 12px;
        }

        .descripcion-seccion {
            text-align: center;
            max-width: 720px;
            margin: 0 auto 35px;
            color: #333;
            line-height: 1.6;
        }

        .panel-acciones {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 18px;
        }

        .btn-primario {
            background-color: var(--brand-red);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .btn-primario:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
        }

        .tabla-usuarios {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 10px 18px rgba(0,0,0,0.08);
        }

        .tabla-usuarios th,
        .tabla-usuarios td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid var(--brand-gray-strong);
        }

        .tabla-usuarios thead {
            background-color: var(--brand-gray);
            text-transform: uppercase;
            font-size: 0.82rem;
            letter-spacing: 0.4px;
        }

        .acciones-usuario {
            display: flex;
            gap: 10px;
        }

        .btn-secundario,
        .btn-eliminar {
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-secundario {
            background-color: #2b2b2b;
            color: white;
        }

        .btn-eliminar {
            background-color: #c62828;
            color: white;
        }

        .estado-usuarios {
            margin-top: 16px;
            font-weight: 600;
            color: #333;
        }

        .estado-usuarios.error {
            color: #c62828;
        }

        .capa-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 10;
        }

        .capa-modal.visible {
            display: flex;
        }

        .modal-usuario {
            background-color: white;
            border-radius: 12px;
            max-width: 520px;
            width: 100%;
            padding: 28px;
            position: relative;
            box-shadow: 0 18px 30px rgba(0,0,0,0.2);
        }

        .modal-usuario h3 {
            margin-top: 0;
            color: var(--brand-red);
        }

        .grupo-campo {
            margin-bottom: 16px;
        }

        .grupo-campo label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .grupo-campo input,
        .grupo-campo select {
            width: 100%;
            padding: 10px 12px;
            border-radius: 6px;
            border: 1px solid var(--brand-gray-strong);
        }

        .acciones-formulario {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn-cancelar {
            background-color: transparent;
            border: 1px solid var(--brand-gray-strong);
            padding: 10px 14px;
            border-radius: 6px;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            header {
                flex-direction: column;
                gap: 12px;
            }

            nav {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                gap: 12px;
            }

            .panel-acciones {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <header>
        <a class="logo-link" href="/">
            <div class="logo-container">
                <img class="logo-img" src="images/LOGO.jpg" alt="Logo J&J Palacios">
                <span>Escuela de Conductores J&J Palacios</span>
            </div>
        </a>
        <nav>
            <a href="/">Inicio</a>
            <a href="/cursos">Cursos</a>
            <a href="/contenidos">Contenidos</a>
            <a href="/contacto">Contacto</a>
            <a href="/usuarios" class="enlace-admin" id="enlace-gestion-usuarios">Gestión usuarios</a>
        </nav>
    </header>

    <main class="main-container">
        <h1 class="titulo-seccion">Gestión de usuarios</h1>
        <p class="descripcion-seccion">
            Desde aquí puedes administrar los usuarios registrados. Crea nuevos registros,
            edita su información o elimina los que ya no sean necesarios en la base de datos.
        </p>

        <div class="panel-acciones">
            <button class="btn-primario" id="btn-crear-usuario" type="button">Crear usuario</button>
        </div>

        <table class="tabla-usuarios" aria-label="Tabla de usuarios">
            <thead>
                <tr>
                    <th>Nombre completo</th>
                    <th>Correo</th>
                    <th>Contraseña</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="tabla-cuerpo-usuarios">
            </tbody>
        </table>

        <p class="estado-usuarios" id="estado-usuarios" role="status" aria-live="polite"></p>
    </main>

    <div class="capa-modal" id="capa-modal-usuario" aria-hidden="true">
        <div class="modal-usuario" role="dialog" aria-modal="true" aria-labelledby="titulo-modal-usuario">
            <h3 id="titulo-modal-usuario">Crear usuario</h3>
            <form id="formulario-usuario">
                <input type="hidden" id="usuario-id">
                <div class="grupo-campo">
                    <label for="usuario-nombre">Nombre completo</label>
                    <input id="usuario-nombre" name="nombre" type="text" required pattern="[^0-9]*" title="El nombre no debe contener números">
                </div>
                <div class="grupo-campo">
                    <label for="usuario-correo">Correo</label>
                    <input id="usuario-correo" name="correo" type="email" required>
                </div>
                <div class="grupo-campo">
                    <label for="usuario-contrasena">Contraseña</label>
                    <input id="usuario-contrasena" name="contrasena" type="password">
                </div>
                <p class="estado-usuarios" id="mensaje-formulario" role="alert" aria-live="assertive"></p>
                <div class="acciones-formulario">
                    <button class="btn-cancelar" type="button" id="btn-cancelar">Cancelar</button>
                    <button class="btn-primario" type="submit" id="btn-guardar">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const origenActual = window.location.origin;
        const esArchivoLocal = origenActual === 'null';
        // Si se abre esta vista directamente, se redirige al inicio para mantener la navegación desde /.
        if (!esArchivoLocal && (!document.referrer || !document.referrer.startsWith(origenActual))) {
            window.location.href = '/';
        }
        const botonCrearUsuario = document.getElementById('btn-crear-usuario');
        const capaModalUsuario = document.getElementById('capa-modal-usuario');
        const formularioUsuario = document.getElementById('formulario-usuario');
        const tituloModalUsuario = document.getElementById('titulo-modal-usuario');
        const campoIdUsuario = document.getElementById('usuario-id');
        const campoNombre = document.getElementById('usuario-nombre');
        const campoCorreo = document.getElementById('usuario-correo');
        const campoContrasena = document.getElementById('usuario-contrasena');
        const cuerpoTablaUsuarios = document.getElementById('tabla-cuerpo-usuarios');
        const estadoUsuarios = document.getElementById('estado-usuarios');
        const mensajeFormulario = document.getElementById('mensaje-formulario');
        const botonCancelar = document.getElementById('btn-cancelar');
        const enlaceGestionUsuarios = document.getElementById('enlace-gestion-usuarios');
        const claveDatosUsuario = 'usuario_datos';
        const correoAdmin = 'admin@gmail.com';

        // Obtiene el correo guardado en la sesión para validar el acceso de administración.
        function obtenerCorreoSesion() {
            try {
                const datosUsuario = JSON.parse(sessionStorage.getItem(claveDatosUsuario));
                if (datosUsuario && typeof datosUsuario.correo === 'string') {
                    return datosUsuario.correo.trim().toLowerCase();
                }
            } catch (error) {
                return '';
            }
            return '';
        }

        // Prepara el header que el backend usa para autorizar acciones de administración.
        function construirEncabezadosAdmin() {
            return {
                'x-correo-sesion': obtenerCorreoSesion()
            };
        }

        // Redirige al inicio si el usuario no es administrador.
        function verificarAccesoAdministrador() {
            const correoSesion = obtenerCorreoSesion();
            const esAdmin = correoSesion === correoAdmin;
            if (enlaceGestionUsuarios) {
                enlaceGestionUsuarios.classList.toggle('visible', esAdmin);
            }
            if (!esAdmin) {
                window.location.href = '/';
                return false;
            }
            return true;
        }

        // Controla la visibilidad del modal para crear o editar usuarios.
        function alternarModalUsuario(mostrar) {
            capaModalUsuario.classList.toggle('visible', mostrar);
            capaModalUsuario.setAttribute('aria-hidden', mostrar ? 'false' : 'true');
            if (!mostrar) {
                formularioUsuario.reset();
                campoIdUsuario.value = '';
                mensajeFormulario.textContent = '';
                mensajeFormulario.classList.remove('error');
            }
        }

        // Centraliza las respuestas de la API propia y valida el indicador de éxito.
        async function solicitarApi(ruta, opciones = {}, mensajeConexion) {
            try {
                const respuesta = await fetch(ruta, opciones);
                const datos = await respuesta.json().catch(() => ({}));
                if (!respuesta.ok || datos.exito === false) {
                    throw new Error(datos.mensaje || 'No se pudo completar la solicitud.');
                }
                return datos;
            } catch (_error) {
                const mensaje = mensajeConexion || 'No se pudo contactar la API de usuarios.';
                throw new Error(mensaje);
            }
        }

        function actualizarEstadoUsuarios(mensaje, esError = false) {
            estadoUsuarios.textContent = mensaje;
            estadoUsuarios.classList.toggle('error', esError);
        }

        function actualizarMensajeFormulario(mensaje, esError = false) {
            mensajeFormulario.textContent = mensaje;
            mensajeFormulario.classList.toggle('error', esError);
        }

        function prepararFormulario(usuario) {
            if (!usuario) {
                tituloModalUsuario.textContent = 'Crear usuario';
                campoContrasena.required = true;
                return;
            }

            tituloModalUsuario.textContent = 'Editar usuario';
            // Garantiza que el formulario conserve el id real enviado por la API.
            const idUsuario = usuario.id_usuario ?? usuario.id ?? '';
            campoIdUsuario.value = idUsuario;
            campoNombre.value = usuario.nombre || '';
            campoCorreo.value = usuario.correo || '';
            campoContrasena.required = false;
            campoContrasena.value = '';
        }

        function renderizarUsuarios(usuarios) {
            cuerpoTablaUsuarios.innerHTML = '';

            if (!usuarios.length) {
                const fila = document.createElement('tr');
                const celda = document.createElement('td');
                celda.colSpan = 4;
                celda.textContent = 'No hay usuarios registrados.';
                fila.appendChild(celda);
                cuerpoTablaUsuarios.appendChild(fila);
                return;
            }

            usuarios.forEach((usuario) => {
                // Normaliza el id para usarlo en las acciones del listado.
                const idUsuario = usuario.id_usuario ?? usuario.id;
                const fila = document.createElement('tr');
                fila.innerHTML = `
                    <td>${usuario.nombre || ''}</td>
                    <td>${usuario.correo || ''}</td>
                    <td>${usuario.contrasena || ''}</td>
                    <td>
                        <div class="acciones-usuario">
                            <button class="btn-secundario" type="button" data-accion="editar">Editar</button>
                            <button class="btn-eliminar" type="button" data-accion="eliminar">Eliminar</button>
                        </div>
                    </td>
                `;

                const [botonEditar, botonEliminar] = fila.querySelectorAll('button');

                botonEditar.addEventListener('click', () => {
                    prepararFormulario({ ...usuario, id: idUsuario });
                    alternarModalUsuario(true);
                });

                botonEliminar.addEventListener('click', () => {
                    eliminarUsuario(idUsuario);
                });

                cuerpoTablaUsuarios.appendChild(fila);
            });
        }

        async function cargarUsuarios() {
            actualizarEstadoUsuarios('Cargando usuarios...');

            try {
                const datos = await solicitarApi(
                    '/api/usuarios',
                    {
                        headers: construirEncabezadosAdmin()
                    },
                    'No se pudo contactar la API de usuarios para obtener los usuarios.'
                );
                // Ajusta la estructura para que el frontend use el id esperado.
                const usuarios = Array.isArray(datos.usuarios)
                    ? datos.usuarios.map((usuario) => ({
                        ...usuario,
                        id: usuario.id_usuario ?? usuario.id
                    }))
                    : [];
                renderizarUsuarios(usuarios);
                actualizarEstadoUsuarios('');
            } catch (error) {
                renderizarUsuarios([]);
                actualizarEstadoUsuarios(error.message, true);
            }
        }

        async function crearUsuario(datosUsuario) {
            const payload = {
                nombre: datosUsuario.nombre,
                correo: datosUsuario.correo,
                contrasena: datosUsuario.contrasena
            };

            await solicitarApi(
                '/api/usuarios',
                {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...construirEncabezadosAdmin()
                    },
                    body: JSON.stringify(payload)
                },
                'No se pudo contactar la API de usuarios para crear el usuario.'
            );
        }

        async function actualizarUsuario(id, datosUsuario) {
            const payload = {
                nombre: datosUsuario.nombre,
                correo: datosUsuario.correo
            };

            if (datosUsuario.contrasena) {
                payload.contrasena = datosUsuario.contrasena;
            }

            await solicitarApi(
                `/api/usuarios/${id}`,
                {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        ...construirEncabezadosAdmin()
                    },
                    body: JSON.stringify(payload)
                },
                'No se pudo contactar la API de usuarios para actualizar el usuario.'
            );
        }

        async function eliminarUsuario(id) {
            if (!id) {
                return;
            }

            const confirmacion = window.confirm('Confirme que desea eliminar este usuario.');
            if (!confirmacion) {
                return;
            }

            try {
                await solicitarApi(
                    `/api/usuarios/${id}`,
                    {
                        method: 'DELETE',
                        headers: construirEncabezadosAdmin()
                    },
                    'No se pudo contactar la API de usuarios para eliminar el usuario.'
                );

                await cargarUsuarios();
            } catch (error) {
                actualizarEstadoUsuarios(error.message, true);
            }
        }

        botonCrearUsuario.addEventListener('click', () => {
            formularioUsuario.reset();
            prepararFormulario(null);
            alternarModalUsuario(true);
        });

        botonCancelar.addEventListener('click', () => {
            alternarModalUsuario(false);
        });

        capaModalUsuario.addEventListener('click', (evento) => {
            if (evento.target === capaModalUsuario) {
                alternarModalUsuario(false);
            }
        });

        formularioUsuario.addEventListener('submit', async (evento) => {
            evento.preventDefault();
            actualizarMensajeFormulario('', false);

            const idUsuario = campoIdUsuario.value.trim();
            const nombre = campoNombre.value.trim();
            const correo = campoCorreo.value.trim();
            const contrasena = campoContrasena.value.trim();

            if (!nombre || !correo) {
                actualizarMensajeFormulario('Debe completar el nombre y el correo.', true);
                return;
            }
            
            if (/\d/.test(nombre)) {
                actualizarMensajeFormulario('El nombre no puede contener números.', true);
                return;
            }

            if (!idUsuario && !contrasena) {
                actualizarMensajeFormulario('Debe ingresar una contraseña para crear el usuario.', true);
                return;
            }

            // Todos los usuarios se registran sin roles, el acceso admin se valida por correo.
            const datosUsuario = {
                nombre,
                correo
            };

            // La contraseña solo se envía si el usuario la completó.
            if (contrasena) {
                datosUsuario.contrasena = contrasena;
            }

            try {
                if (idUsuario) {
                    await actualizarUsuario(idUsuario, datosUsuario);
                } else {
                    await crearUsuario(datosUsuario);
                }

                alternarModalUsuario(false);
                await cargarUsuarios();
            } catch (error) {
                actualizarMensajeFormulario(error.message, true);
            }
        });

        const accesoPermitido = verificarAccesoAdministrador();
        if (accesoPermitido) {
            cargarUsuarios();
        }
    </script>
</body>
</html>
